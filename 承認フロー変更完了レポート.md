# 承認フロー変更 - 実装完了レポート

## 変更内容サマリー

月次勤怠の承認フローを以下のように変更しました：

### Before（変更前）
- **月次確認画面**: 担当者印と承認印の両方を表示
  - 担当者が自分の担当者印を押す
  - 承認者が同じ画面で承認印を押す（社員コードを手入力）

### After（変更後）
- **月次確認画面**: 担当者印のみ表示
  - 担当者が自分の勤怠データを確認し、担当者印を押す
  - 承認状態（承認待ち/承認済み）を表示
  
- **管理者ダッシュボード**: 承認権限者専用
  - 承認権限者がログイン
  - 承認対象の部下を一覧表示
  - 一覧から「承認する」ボタンで承認印を押す

## 変更したファイル

### 1. MonthlyReview.html

#### 削除した機能
- ❌ 承認印セクション（2段組の印鑑表示）
- ❌ `stampBoss()` 関数（承認印を押す関数）

#### 追加・変更した機能
- ✅ 担当者確認セクション（1段組に変更）
- ✅ 承認状態の表示
  - 承認済み: 緑の背景で承認者名と日時を表示
  - 承認待ち: 黄色の背景で「承認待ち」を表示
- ✅ 説明文の追加
  - 「勤怠データを確認し、間違いがなければ担当者印を押してください。」
  - 「承認は管理者ダッシュボードから承認者が行います。」

### 2. ManagerDashboard.html

#### 既存の機能（確認済み）
- ✅ 承認権限者の認証
  - 社員マスタのE列（第1承認者）に名前がある人のみアクセス可能
- ✅ 部下の一覧表示
  - 社員名、勤怠状況、本人確認、ステータスを表示
- ✅ 承認ボタン
  - 条件: 勤怠データ完備 AND 本人確認済み
  - ボタンクリックで承認印を押す
- ✅ カレンダー詳細ボタン
  - 部下の月次確認画面に遷移

## 使い方

### 一般社員（担当者）の操作

1. **月次確認画面を開く**
   ```
   MonthlyReview.html
   ```

2. **自分の社員コードと年月を入力**
   - 社員コード: 自分のコード
   - 年月: 確認したい年月

3. **データを確認**
   - カレンダー形式で出勤・退勤時刻を確認
   - 間違いがないか確認

4. **担当者印を押す**
   - 「担当者印を押す」ボタンをクリック
   - 確認ダイアログで「OK」をクリック

5. **承認状態を確認**
   - **承認待ち**: 黄色の枠で「⏳ 承認待ち」と表示
   - **承認済み**: 緑の枠で「✅ 承認済み」と承認者名を表示

### 承認権限者（管理者）の操作

1. **管理者ダッシュボードを開く**
   ```
   ManagerDashboard.html
   ```

2. **自分の社員コードと年月を入力**
   - 管理者社員コード: 自分のコード
   - 対象年月: 承認したい年月

3. **データを表示**
   - 「データを表示」ボタンをクリック
   - 承認対象の部下が一覧表示される

4. **統計情報を確認**
   - 対象人数: 承認対象の部下の総数
   - 承認待ち: 承認可能な人数
   - 承認済み: 既に承認済みの人数

5. **部下の勤怠を確認（オプション）**
   - 📅詳細ボタンをクリック
   - 部下の月次確認画面に遷移
   - カレンダー形式で詳細を確認

6. **承認する**
   - 「承認する」ボタンをクリック
   - 確認ダイアログで「OK」をクリック
   - 承認完了のメッセージが表示される
   - 一覧が自動的に更新される

## 承認条件

承認ボタンが有効になる条件:
- ✅ 勤怠データが完備している（出勤日数 ≧ 必要日数）
- ✅ 本人確認が完了している（担当者印が押されている）

承認ボタンが無効になる場合:
- ❌ 勤怠データが不足している
- ❌ 本人確認が完了していない（担当者印が押されていない）

## データの流れ

```
[一般社員]
1. 月次確認画面で勤怠データを確認
2. 担当者印を押す
   ↓
[Google Spreadsheet]
3. 「月次承認記録_個人」シートに記録
   - A列: 年月
   - B列: 社員ID
   - C列: 本人確認者（担当者の名前）
   - D列: 本人確認日時
   ↓
[承認権限者]
4. 管理者ダッシュボードで部下の一覧を表示
5. 承認可能な部下に「承認する」ボタンが表示される
6. 承認ボタンをクリック
   ↓
[Google Spreadsheet]
7. 「月次承認記録_個人」シートを更新
   - E列: 承認者（管理者の名前）
   - F列: 承認日時
   ↓
[一般社員]
8. 月次確認画面で「承認済み」が表示される
```

## 権限管理

### 承認権限の設定方法

1. **社員マスタシートを開く**

2. **E列（第1承認者）に管理者の名前を設定**
   ```
   例:
   A列     B列      C列    D列   E列（第1承認者）
   001     山田太郎  営業部        佐藤花子
   002     鈴木一郎  営業部        佐藤花子
   003     佐藤花子  営業部        田中次郎
   ```

3. **注意点**
   - E列の名前は、B列（氏名）に存在する名前と**完全一致**する必要があります
   - スペースや全角・半角も厳密にチェックされます
   - 例: 「佐藤花子」≠「佐藤 花子」（スペースの有無）

### 承認権限の確認方法

1. 管理者ダッシュボードにログイン
2. 自分の社員コードを入力して「データを表示」
3. **承認対象が表示される** → 承認権限あり ✅
4. **「アクセス権限がありません」** → 承認権限なし ❌

## トラブルシューティング

### Q1: 承認ボタンが「不可」になっている

**原因1: 勤怠データが不足**
- 解決方法: 対象社員に打刻を促す

**原因2: 本人確認が完了していない**
- 解決方法: 対象社員に月次確認画面で担当者印を押してもらう

### Q2: 管理者ダッシュボードに部下が表示されない

**原因1: 社員マスタのE列に自分の名前が登録されていない**
- 解決方法: 社員マスタのE列を確認し、自分の名前を追加

**原因2: 名前の表記が一致していない**
- 解決方法: B列とE列の名前が完全に一致しているか確認

### Q3: 承認印を押したのに「承認済み」にならない

**原因: ブラウザのキャッシュ**
- 解決方法: ページをリロード（F5キー）

**原因: Google Apps Scriptのエラー**
- 解決方法: スプレッドシートの「デバッグログ」シートを確認

## スプレッドシートの構造

### 月次承認記録_個人シート

| A列 | B列 | C列 | D列 | E列 | F列 |
|-----|-----|-----|-----|-----|-----|
| 年月 | 社員ID | 本人確認者 | 本人確認日時 | 承認者 | 承認日時 |
| 2024-12 | 001 | 山田太郎 | 2024/12/12 10:00 | 佐藤花子 | 2024/12/13 15:00 |
| 2024-12 | 002 | 鈴木一郎 | 2024/12/12 11:00 | | |

## メリット

### 変更前の問題点
- ❌ 承認者が社員コードを手入力する必要がある（入力ミスの可能性）
- ❌ 承認対象を探すのが大変（誰を承認すべきかわからない）
- ❌ 承認状況の一覧が見れない

### 変更後のメリット
- ✅ 承認者は部下の一覧から選んでクリックするだけ（入力ミス防止）
- ✅ 承認対象が一目でわかる（承認待ち人数を表示）
- ✅ 承認状況を一覧で確認できる（統計情報表示）
- ✅ 勤怠詳細もすぐに確認できる（📅詳細ボタン）

## まとめ

承認フローを以下のように分離しました:

- **一般社員**: 月次確認画面で担当者印のみ押す
- **承認権限者**: 管理者ダッシュボードで部下の承認を一括管理

これにより、承認業務がより効率的になり、ミスも防止できます！🎉
