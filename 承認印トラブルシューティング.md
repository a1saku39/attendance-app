# 月次勤怠確認の承認印トラブルシューティングガイド

## 問題: 承認印が押せない

承認印機能を強化し、詳細なエラーメッセージとデバッグログを追加しました。

## 確認すべきこと

### 1. **ブラウザのコンソールを確認**

1. Webブラウザで月次勤怠確認画面を開く
2. `F12`キーを押して開発者ツールを開く
3. `Console`タブを選択
4. 承認印ボタンを押す
5. コンソールに表示されるエラーメッセージを確認

**出力されるログ:**
- `=== 担当者印を押す処理開始 ===`
- `currentEmployeeId: XXXX`
- `currentYearMonth: YYYY-MM`
- `GAS URL: https://...`
- `送信データ: {object}`
- `レスポンスステータス: 200`
- `押印結果: {object}`

### 2. **Google スプレッドシートのデバッグログを確認**

1. Google スプレッドシートを開く
2. 「デバッグログ」シートを開く
3. 最新の行を確認

**記録される情報:**
- `recordApproval開始: {リクエストデータ}`
- `承認者情報: {社員情報}`
- `印鑑名: XXXX`
- エラーがあればエラー内容

### 3. **よくあるエラーと対処法**

#### エラー1: 「社員マスタシートが存在しません」
**原因:** 社員マスタシートが作成されていない  
**対処法:**
1. Googleスプレッドシートに「社員マスタ」という名前のシートを作成
2. 以下のヘッダーを設定:
   ```
   A列: 社員コード
   B列: 氏名
   C列: 部署
   D列: 承認対象部署
   E列: 第1承認者
   F列: 第2承認者
   ```
3. 社員データを登録

#### エラー2: 「操作者(社員コード: XXX)の情報がマスタに見つかりません」
**原因:** 入力した社員コードが社員マスタに登録されていない  
**対処法:**
1. 社員マスタシートを開く
2. A列(社員コード)に該当するコードがあるか確認
3. なければ新しい行に社員情報を追加

#### エラー3: 「あなたはこの社員の承認権限を持っていません」
**原因:** 社員マスタのE列(第1承認者)に承認者の名前が登録されていない  
**対処法:**
1. 社員マスタシートを開く
2. 対象社員の行のE列(第1承認者)を確認
3. 承認者の氏名(B列と完全一致する名前)を入力
   - 例: 対象社員が「山田太郎」、承認者が「佐藤花子」の場合
   - 山田太郎の行のE列に「佐藤花子」と入力
   - 「佐藤花子」はB列のどこかに存在している必要がある

#### エラー4: 「本人確認が完了していません」
**原因:** 担当者印(本人確認)が押されていない状態で承認印を押そうとした  
**対処法:**
1. まず担当者印を押す(本人が自分の社員コードでログイン)
2. その後、承認者が承認印を押す

#### エラー5: 「GAS WebアプリのURLが設定されていません」
**原因:** ローカルストレージにGAS URLが保存されていない  
**対処法:**
1. 打刻画面(`index.html`)を開く
2. 設定セクションで「GAS WebアプリのURL」を入力して保存
3. 月次勤怠確認画面を再度開く

### 4. **確認チェックリスト**

- [ ] 社員マスタシートが存在する
- [ ] 社員マスタに自分の社員コードと氏名が登録されている
- [ ] GAS WebアプリのURLが設定されている
- [ ] Google Apps ScriptがWebアプリとしてデプロイされている
- [ ] (承認印の場合) 対象社員のE列(第1承認者)に自分の名前が入っている
- [ ] (承認印の場合) 自分の名前がB列(氏名)のどこかに存在する(完全一致)
- [ ] (承認印の場合) 担当者印が既に押されている

### 5. **デバッグの手順**

1. **担当者印を押してみる**
   - ブラウザのコンソールを開く
   - 「担当者印を押す」ボタンをクリック
   - コンソールのログを確認
   - スプレッドシートの「デバッグログ」シートを確認

2. **エラーメッセージを読む**
   - 画面に表示されたエラーメッセージを確認
   - エラーメッセージに従って対処

3. **社員マスタを確認**
   - 社員コードが正しいか
   - 氏名が正しいか
   - 第1承認者が正しく設定されているか

4. **GAS Webアプリを再デプロイ**
   - Google Apps Scriptエディタを開く
   - `デプロイ` → `新しいデプロイ`
   - 説明に日時を入力(例: 2025-12-12 更新)
   - `デプロイ`をクリック
   - 新しいURLが表示されたら、設定画面で更新

## 変更内容

### MonthlyReview.html
- `stampSelf()` 関数: 詳細なログとエラーチェックを追加
- `stampBoss()` 関数: 詳細なログとエラーチェックを追加

### Code.gs
- `recordApproval()` 関数: デバッグログを各ステップで出力
- エラーメッセージをより詳細に変更
- 社員マスタの存在確認を追加

## 次のステップ

1. 上記のチェックリストを確認
2. 承認印を押してみる
3. エラーが出たら、ブラウザのコンソールとスプレッドシートのデバッグログを確認
4. エラーメッセージに従って対処
5. 問題が解決しない場合は、エラーログの内容を共有してください
