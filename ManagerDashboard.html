<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - å‹¤æ€ ç®¡ç†</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 1.5rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-btn {
            text-decoration: none;
            color: var(--text-sub);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dashboard-controls {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 20px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
        }

        input {
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-primary {
            background: var(--primary);
        }

        .status-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .modal-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            color: var(--text-sub);
            font-size: 0.9rem;
        }

        .employee-list {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f9fafb;
            padding: 15px;
            text-align: left;
            font-size: 0.9rem;
            color: var(--text-sub);
            border-bottom: 1px solid #e5e7eb;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.95rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-ok {
            background: #d1fae5;
            color: #065f46;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .action-btn {
            background: var(--success);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            border: none;
            cursor: pointer;
        }

        .action-btn:disabled {
            background: #e5e7eb;
            cursor: not-allowed;
            color: #9ca3af;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: var(--text-sub);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .dashboard-controls {
                flex-direction: column;
                align-items: stretch;
            }

            th,
            td {
                padding: 10px;
                font-size: 0.85rem;
            }

            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚«ãƒ¼ãƒ‰å½¢å¼ã«ã™ã‚‹ãªã©ã®ã‚¹ãƒãƒ›æœ€é©åŒ–ã‚‚å¯èƒ½ã ãŒä»Šå›ã¯ç°¡æ˜“å¯¾å¿œ */
            .hide-mobile {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div>
                <a href="index.html" class="back-btn">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</a>
                <h1>ğŸ‘‘ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            </div>
            <div id="approverNameDisplay" style="font-weight: bold; color: var(--primary);">
                <!-- ã“ã“ã«æ‰¿èªè€…åã‚’è¡¨ç¤º -->
            </div>
        </div>

        <div class="dashboard-controls">
            <div class="control-group">
                <label for="approverId">ç®¡ç†è€…ç¤¾å“¡ã‚³ãƒ¼ãƒ‰</label>
                <input type="text" id="approverId" placeholder="ã‚ãªãŸã®ç¤¾å“¡ã‚³ãƒ¼ãƒ‰">
            </div>
            <div class="control-group">
                <label for="yearMonth">å¯¾è±¡å¹´æœˆ</label>
                <input type="month" id="yearMonth">
            </div>
            <button class="btn btn-primary" onclick="loadDashboard()">ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º</button>
            <a href="HolidaySettings.html" class="btn"
                style="background:#6b7280; text-decoration: none; margin-left: auto;">ğŸ“… ä¼‘æ—¥è¨­å®šã¸</a>
        </div>

        <div id="statsArea" class="status-cards" style="display: none;">
            <div class="modal-card">
                <div class="stat-number" id="statsTotal">0</div>
                <div class="stat-label">å¯¾è±¡äººæ•°</div>
            </div>
            <div class="modal-card">
                <div class="stat-number" id="statsPending" style="color: var(--warning);">0</div>
                <div class="stat-label">æ‰¿èªå¾…ã¡</div>
            </div>
            <div class="modal-card">
                <div class="stat-number" id="statsApproved" style="color: var(--success);">0</div>
                <div class="stat-label">æ‰¿èªæ¸ˆã¿</div>
            </div>
        </div>

        <div id="dataArea">
            <div style="text-align: center; color: var(--text-sub); margin-top: 50px;">
                ç®¡ç†è€…æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã€Œãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã€ã‚’æŠ¼ã—ã¦ãã ã•ã„
            </div>
        </div>
    </div>

    <script>
        window.onload = function () {
            const today = new Date();
            const yearMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('yearMonth').value = yearMonth;

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å‰å›å…¥åŠ›ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’å¾©å…ƒ
            const savedId = localStorage.getItem('attendance_approver_id') || localStorage.getItem('attendance_employee_id');
            if (savedId) {
                document.getElementById('approverId').value = savedId;
            }
        };

        function loadDashboard() {
            const approverId = document.getElementById('approverId').value.trim();
            const yearMonth = document.getElementById('yearMonth').value;

            if (!approverId) {
                alert('ç®¡ç†è€…ç¤¾å“¡ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            localStorage.setItem('attendance_approver_id', approverId);
            const gasUrl = localStorage.getItem('attendance_gas_url');

            if (!gasUrl) {
                alert('GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å‹¤æ€ ã‚¢ãƒ—ãƒªã®è¨­å®šç”»é¢ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            document.getElementById('dataArea').innerHTML = '<div class="loading">æ¤œç´¢ä¸­...</div>';
            document.getElementById('statsArea').style.display = 'none';

            fetch(gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({
                    action: 'getApproverDashboard',
                    approverId: approverId,
                    yearMonth: yearMonth
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success') {
                        if (data.isApprover) {
                            displayDashboard(data.subordinates, yearMonth);
                        } else {
                            document.getElementById('dataArea').innerHTML = `
                            <div style="text-align: center; padding: 40px; background: white; border-radius: 12px;">
                                <h3 style="color: var(--danger);">ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                                <p style="margin-top: 10px; color: var(--text-sub);">
                                    ã‚ãªãŸã®ç¤¾å“¡ã‚³ãƒ¼ãƒ‰ã¯ã€ç¤¾å“¡ãƒã‚¹ã‚¿ã®ã€Œç¬¬1æ‰¿èªè€…ï¼ˆEåˆ—ï¼‰ã€ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>
                                    ã¾ãŸã¯ã€æ‰¿èªå¯¾è±¡ã¨ãªã‚‹éƒ¨ä¸‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
                                </p>
                            </div>
                        `;
                        }
                    } else {
                        alert('ã‚¨ãƒ©ãƒ¼: ' + data.message);
                        document.getElementById('dataArea').innerHTML = '';
                    }
                })
                .catch(error => {
                    console.error(error);
                    document.getElementById('dataArea').innerHTML = '<div style="color:red; text-align:center">é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
                });
        }

        function displayDashboard(subordinates, yearMonth) {
            const container = document.getElementById('dataArea');
            const statsArea = document.getElementById('statsArea');

            // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®—
            const total = subordinates.length;
            const approved = subordinates.filter(s => s.status.boss).length;
            const pending = subordinates.filter(s => s.canApprove).length;

            document.getElementById('statsTotal').textContent = total;
            document.getElementById('statsPending').textContent = pending;
            document.getElementById('statsApproved').textContent = approved;
            statsArea.style.display = 'grid';

            let html = `
                <div class="employee-list">
                    <table>
                        <thead>
                            <tr>
                                <th>ç¤¾å“¡å</th>
                                <th>å‹¤æ€ çŠ¶æ³</th>
                                <th class="hide-mobile">æœ¬äººç¢ºèª</th>
                                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th style="text-align: center;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>`;

            subordinates.forEach(sub => {
                const progressText = `${sub.attendanceDays}/${sub.workDays}æ—¥`;
                const isComplete = sub.attendanceDays >= sub.workDays;

                let statusBadge = '';
                let actionBtn = '';

                if (sub.status.boss) {
                    statusBadge = '<span class="status-badge status-ok">æ‰¿èªæ¸ˆã¿</span>';
                    actionBtn = '<button class="action-btn" disabled>å®Œäº†</button>';
                } else if (sub.canApprove) {
                    statusBadge = '<span class="status-badge status-warning">æ‰¿èªå¾…ã¡</span>';
                    actionBtn = `<button class="action-btn" onclick="approveEmployee('${sub.id}', '${yearMonth}')">æ‰¿èªã™ã‚‹</button>`;
                } else {
                    statusBadge = '<span class="status-badge status-error">æœªå®Œäº†</span>';
                    actionBtn = `<button class="action-btn" disabled title="å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã¾ãŸã¯æœ¬äººæœªç¢ºèª">ä¸å¯</button>`;
                }

                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è©³ç´°ãƒœã‚¿ãƒ³
                const calendarBtn = `<button class="action-btn" style="background:#6366f1; margin-right:5px;" onclick="viewMemberCalendar('${sub.id}', '${yearMonth}')">ğŸ“… è©³ç´°</button>`;

                // æœ¬äººç¢ºèªã‚¢ã‚¤ã‚³ãƒ³
                const selfCheckIcon = sub.status.self ? 'âœ…' : '<span style="color:#ccc">æœª</span>';

                html += `
                    <tr>
                        <td>
                            <div style="font-weight: bold;">${sub.name}</div>
                            <div style="font-size: 0.8rem; color: #6b7280;">${sub.department}</div>
                        </td>
                        <td>
                            ${progressText}
                            ${!isComplete ? '<span style="color:red; font-size:10px">ä¸è¶³</span>' : ''}
                        </td>
                        <td class="hide-mobile" style="text-align:center;">${selfCheckIcon}</td>
                        <td>${statusBadge}</td>
                        <td style="text-align: center;">${calendarBtn}${actionBtn}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        function viewMemberCalendar(employeeId, yearMonth) {
            // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»˜ã‘ã¦æœˆæ¬¡ç¢ºèªç”»é¢ã¸é·ç§»
            // from=manager ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§ã€é·ç§»å…ˆã§ã€Œæˆ»ã‚‹ãƒœã‚¿ãƒ³ã€ã‚’è¡¨ç¤ºã•ã›ã‚‹
            window.location.href = `MonthlyReview.html?employeeId=${employeeId}&yearMonth=${yearMonth}&from=manager`;
        }

        function approveEmployee(targetId, yearMonth) {
            if (!confirm('æ‰¿èªå°ã‚’æŠ¼ã—ã¾ã™ã‹ï¼Ÿ')) return;

            const approverId = document.getElementById('approverId').value;
            const gasUrl = localStorage.getItem('attendance_gas_url');

            fetch(gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({
                    action: 'recordApproval',
                    targetEmployeeId: targetId,
                    approverId: approverId,
                    yearMonth: yearMonth,
                    type: 'boss'
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success') {
                        alert('æ‰¿èªå®Œäº†ã—ã¾ã—ãŸ');
                        loadDashboard(); // å†èª­ã¿è¾¼ã¿
                    } else {
                        alert('ã‚¨ãƒ©ãƒ¼: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
                });
        }
    </script>
</body>

</html>