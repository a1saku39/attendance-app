# 承認印ボタンが表示されない問題 - デバッグ手順

## 問題の状況
- ✅ 担当者印は押せる
- ❌ 承認印ボタンが表示されない

## 実装したデバッグ機能

### 1. ブラウザコンソールでの確認

月次勤怠確認画面を開いて、ブラウザの開発者ツール(F12)のConsoleタブで以下の情報が表示されます:

```
取得したデータ: {result: "success", data: {...}, approvalStatus: {...}}
approvalStatus: {self: {...}, boss: null}
currentApprovalStatus設定後: {self: {...}, boss: null}
self: {name: "山田太郎", date: "2024-12-12T..."}
boss: null
```

### 2. 確認すべきポイント

#### ケース1: `approvalStatus: undefined` または `approvalStatus: null`  
**原因:** Google Apps Scriptの`getPersonalMonthlyData`関数が`approvalStatus`を返していない  
**対処法:**
1. Google Apps Scriptエディタを開く
2. `Code.gs`の1264行目あたりを確認
3. 以下のコードがあるか確認:
   ```javascript
   var approvalStatus = getApprovalStatus(employeeId, yearMonth);
   ```
4. return文で`approvalStatus`を含めているか確認:
   ```javascript
   return ContentService.createTextOutput(JSON.stringify({
     result: 'success',
     data: personalData,
     approvalStatus: approvalStatus  // ← これが必要
   })).setMimeType(ContentService.MimeType.JSON);
   ```
5. Google Apps Scriptを再デプロ

イ
#### ケース2: `self: null` のまま（担当者印を押したのに）
**原因:** 担当者印の記録が`月次承認記録_個人`シートに保存されていない  
**対処法:**
1. Googleスプレッドシートを開く
2. 「月次承認記録_個人」シートを確認
3. 以下の列が存在するか確認:
   ```
   A列: 年月 (例: 2024-12)
   B列: 社員ID (例: 001)
   C列: 本人確認者 (例: 山田太郎)
   D列: 本人確認日時
   E列: 承認者
   F列: 承認日時
   ```
4. 担当者印を押した後、該当する行が追加されているか確認
5. もし追加されていない場合は、「デバッグログ」シートでエラーを確認

#### ケース3: `self: {name: "...", date: "..."}` だが、ボタンが表示されない
**原因:** 表示ロジックの問題  
**対処法:**
1. ブラウザのConsoleで以下を実行:
   ```javascript
   console.log(currentApprovalStatus);
   ```
2. 出力結果を確認
3. MonthlyReview.htmlの686-695行目のロジックを確認:
   ```javascript
   ${currentApprovalStatus.boss ?
       `<div class="stamp">${currentApprovalStatus.boss.name}</div>
        <div class="stamp-date">${formatDate(currentApprovalStatus.boss.date)}</div>` :
       currentApprovalStatus.self ?
           `<button class="stamp-button" onclick="stampBoss()">承認印を押す</button>` :
           `<div style="color: #999; font-size: 13px;">担当者印が必要です</div>`
   }
   ```

#### ケース4: 年月のフォーマット不一致
**原因:** HTMLから送信される年月と、スプレッドシートに保存されている年月のフォーマットが異なる  
**例:**
- HTMLから: `2024-12`
- シートに保存: `2024/12` または `2024年12月`

**対処法:**
1. 「月次承認記録_個人」シートのA列(年月)のフォーマットを確認
2. `2024-12`形式で統一されているか確認
3. もし異なる場合は、Code.gsの`getApprovalStatus`関数で正規化処理を追加

## デバッグ手順

### ステップ1: ブラウザコンソールで確認
1. 月次勤怠確認画面を開く
2. F12キーで開発者ツールを開く
3. Consoleタブを選択
4. 「データを表示」ボタンをクリック
5. コンソールに表示されるログを確認

### ステップ2: スプレッドシートで確認
1. Googleスプレッドシートを開く
2. 「月次承認記録_個人」シートを開く
3. 該当する年月と社員IDの行があるか確認
4. C列(本人確認者)に名前が入っているか確認

### ステップ3: デバッグログで確認
1. Googleスプレッドシートの「デバッグログ」シートを開く
2. 最新の行を確認
3. エラーメッセージがないか確認

### ステップ4: Google Apps Scriptを再デプロイ
1. Google Apps Scriptエディタを開く
2. 右上の「デプロイ」→「新しいデプロイ」
3. 説明に日時を入力(例: 2024-12-12 承認印修正)
4. 「デプロイ」をクリック
5. 新しいURLをコピー
6. 打刻画面の設定でURLを更新

## 最も可能性の高い原因

担当者印を押せているということは、基本的な動作は正常です。
承認印ボタンが表示されない原因として最も可能性が高いのは:

**原因A: `approvalStatus`が正しく返されていない**
- Code.gsの`getPersonalMonthlyData`関数を確認
- return文に`approvalStatus`が含まれているか確認

**原因B: 年月フォーマットの不一致**
- 「月次承認記録_個人」シートのA列のフォーマットを確認
- `2024-12`形式になっているか確認（`2024/12`や`2024年12月`ではない）

## 次のアクション

1. ブラウザのコンソールで`approvalStatus`の値を確認
2. その結果をもとに、上記のケースから該当するものを特定
3. 対処法を実施
4. 問題が解決しない場合は、コンソールの出力内容を共有

---

## 更新内容

### MonthlyReview.html  
- `loadMonthlyData`関数に詳細なコンソールログを追加
- `approvalStatus`の各値をログ出力

### Code.gs (既存)
- `getApprovalStatus`関数: 承認状態を取得
- `recordApproval`関数: 承認印を記録

これで、ブラウザのコンソールを見れば、どの時点で問題が発生しているか特定できます。
